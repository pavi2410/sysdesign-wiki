---
interface Props {
  chart: string;
  caption?: string;
}

const { chart, caption } = Astro.props;
const id = `mermaid-${Math.random().toString(36).slice(2, 9)}`;
---

<figure class="my-8">
  <div
    class="mermaid-container bg-paper-warm border border-border rounded-xl p-6 overflow-x-auto"
    id={id}
    data-chart={chart}
  >
    <div class="flex items-center justify-center py-8 text-ink-muted text-sm">
      <svg class="animate-spin w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
      </svg>
      Loading diagram...
    </div>
  </div>
  {caption && (
    <figcaption class="mt-3 text-center text-sm text-ink-muted italic font-serif">
      {caption}
    </figcaption>
  )}
</figure>

<script>
  import mermaid from 'mermaid';

  mermaid.initialize({
    startOnLoad: false,
    theme: 'base',
    themeVariables: {
      primaryColor: '#f5f3ef',
      primaryTextColor: '#1a1a1a',
      primaryBorderColor: '#c8c4bc',
      lineColor: '#6b4c3b',
      secondaryColor: '#eae7e1',
      tertiaryColor: '#fff8e1',
      fontFamily: '"Inter", system-ui, sans-serif',
      fontSize: '13px',
      nodeBorder: '#6b4c3b',
      mainBkg: '#f5f3ef',
      clusterBkg: '#fafaf8',
      clusterBorder: '#e0ddd7',
      titleColor: '#1a1a1a',
      edgeLabelBackground: '#fafaf8',
      nodeTextColor: '#1a1a1a',
    },
    flowchart: {
      htmlLabels: true,
      curve: 'basis',
      padding: 15,
      nodeSpacing: 50,
      rankSpacing: 60,
    },
    sequence: {
      actorMargin: 50,
      boxMargin: 10,
      mirrorActors: false,
      messageMargin: 40,
    },
  });

  async function renderDiagrams() {
    const containers = document.querySelectorAll('.mermaid-container');
    for (const container of containers) {
      const chart = container.getAttribute('data-chart');
      if (!chart) continue;
      try {
        const { svg } = await mermaid.render(`svg-${container.id}`, chart);
        container.innerHTML = svg;
        const svgEl = container.querySelector('svg');
        if (svgEl) {
          svgEl.style.maxWidth = '100%';
          svgEl.style.height = 'auto';
        }
      } catch (e) {
        container.innerHTML = `<div class="text-red-600 text-sm p-4">Failed to render diagram</div>`;
        console.error('Mermaid render error:', e);
      }
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', renderDiagrams);
  } else {
    renderDiagrams();
  }
</script>
